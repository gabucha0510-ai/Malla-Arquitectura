<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Malla Interactiva - Arquitectura USB</title>
<style>
  :root{
    /* Paleta basada en la imagen: vibrante suave, unicolor */
    --c1: #E7CA94; /* beige-amarillo */
    --c2: #BFD1B7; /* verde suave */
    --c3: #C6B2CB; /* lila suave */
    --c4: #C8B69E; /* arena */
    --c5: #C7E9F8; /* azul cielo */
    --c6: #F0BDCF; /* rosa pálido */
    --c7: #8A454E; /* borgoña oscuro - acento */
    --bg: #fbfbfb;
    --card-bg: #ffffff;
    --muted: #6b6b6b;
    --ok: #2a8f6f;
    --locked: rgba(0,0,0,0.08);
    --font: "Inter", "Helvetica Neue", Arial, sans-serif;
  }

  html,body{height:100%; margin:0; background:var(--bg); font-family:var(--font); color:#222;}
  header{
    padding:14px 20px;
    display:flex;
    gap:12px;
    align-items:center;
    border-bottom:1px solid rgba(0,0,0,0.06);
    background:linear-gradient(90deg, rgba(255,255,255,0.6), rgba(255,255,255,0.85));
  }
  header h1{font-size:18px; margin:0;}
  header p{margin:0; color:var(--muted); font-size:13px;}

  .controls{
    margin-left:auto; display:flex; gap:10px; align-items:center;
  }
  .controls label{font-size:13px; color:var(--muted); display:flex; gap:6px; align-items:center;}
  .btn{
    background:var(--card-bg); border:1px solid rgba(0,0,0,0.06); padding:6px 10px; border-radius:8px; cursor:pointer;
    font-size:13px;
  }
  .wrap{
    padding:18px;
    overflow:auto;
  }

  /* Grid for trimesters - responsive */
  .grid{
    display:grid;
    grid-template-columns: repeat(5, minmax(220px, 1fr));
    gap:18px;
    align-items:start;
  }
  @media (max-width:1100px){
    .grid{ grid-template-columns: repeat(3, minmax(220px,1fr)); }
  }
  @media (max-width:700px){
    .grid{ grid-template-columns: repeat(1, minmax(220px,1fr)); }
  }

  .col{
    background:transparent;
    position:relative;
    padding:12px;
    border-radius:12px;
  }
  .col h3{
    margin:0 0 8px 0; font-size:14px; color:var(--muted);
  }

  .course{
    user-select:none;
    display:flex;
    flex-direction:column;
    gap:4px;
    padding:10px;
    border-radius:8px;
    margin-bottom:10px;
    min-height:44px;
    box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    cursor:pointer;
    position:relative;
    transition:transform .08s ease, box-shadow .08s ease, opacity .12s;
    font-size:13px;
  }
  .course .code{ font-weight:700; font-size:12px; opacity:0.95;}
  .course .name{ font-size:12px; color:#222; opacity:0.9;}
  .course .meta{ font-size:11px; color:var(--muted); }

  /* colors by group: we'll alternate using palette */
  .c1{ background: var(--c1); color:#2f2f2f }
  .c2{ background: var(--c2); color:#16351f }
  .c3{ background: var(--c3); color:#2b1530 }
  .c4{ background: var(--c4); color:#2b2b2b }
  .c5{ background: var(--c5); color:#083246 }
  .c6{ background: var(--c6); color:#3b1420 }
  .accent{ border-left:4px solid var(--c7); padding-left:8px; }

  .course.approved{
    outline:2px solid rgba(42,143,111,0.12);
    box-shadow: 0 4px 12px rgba(42,143,111,0.08);
    transform: translateY(-2px);
    position:relative;
  }
  .course.locked{
    opacity:0.55;
    box-shadow:none;
    cursor:default;
    background: linear-gradient(0deg, rgba(0,0,0,0.03), transparent);
  }
  .course.locked::after{
    content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(255,255,255,0.0), rgba(255,255,255,0.0));
  }

  /* small badge for approved */
  .badge{
    position:absolute; right:8px; top:8px; font-size:11px; padding:4px 6px; border-radius:999px;
    background:rgba(255,255,255,0.85); border:1px solid rgba(0,0,0,0.06); color:var(--ok);
  }

  /* tooltip */
  .tooltip{
    position:absolute; z-index:30; pointer-events:none; transform:translate(-50%,-110%);
    background:#222; color:#fff; font-size:12px; padding:8px 10px; border-radius:6px; white-space:nowrap;
    opacity:0; transition:opacity .12s;
  }
  .tooltip.show{ opacity:1; pointer-events:auto; transform:translate(-50%,-120%); }

  /* svg overlay for lines */
  #connectSvg{
    position:absolute; inset:0; pointer-events:none; z-index:5;
  }

  footer{ padding:10px 18px; font-size:13px; color:var(--muted); border-top:1px solid rgba(0,0,0,0.03); background:transparent;}
  .legend{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-left:6px;}
  .legend .sw{ width:18px; height:18px; border-radius:4px; display:inline-block; border:1px solid rgba(0,0,0,0.06); }

  /* small helper styles */
  .small{ font-size:12px; color:var(--muted); }
</style>
</head>
<body>
<header>
  <div>
    <h1>Malla Interactiva — Arquitectura (USB)</h1>
    <p class="small">Marca materias como aprobadas; las dependientes se desbloquean automáticamente. Progreso guardado en tu navegador.</p>
  </div>

  <div class="controls">
    <label title="Marca si ya tienes 40 unidades aprobadas">
      <input id="has40" type="checkbox" /> Tengo 40 unidades aprobadas
    </label>
    <button id="resetBtn" class="btn" title="Resetear progreso">Resetear progreso</button>
  </div>
</header>

<div class="wrap" id="wrap">
  <!-- SVG overlay for connections -->
  <svg id="connectSvg" xmlns="http://www.w3.org/2000/svg"></svg>

  <!-- Grid of trimesters -->
  <div id="grid" class="grid"></div>
</div>

<footer>
  <div style="display:flex; align-items:center; justify-content:space-between;">
    <div class="small">Paleta: <span class="legend">
      <span class="sw" style="background:var(--c1)"></span>
      <span class="sw" style="background:var(--c2)"></span>
      <span class="sw" style="background:var(--c3)"></span>
      <span class="sw" style="background:var(--c4)"></span>
      <span class="sw" style="background:var(--c5)"></span>
      <span class="sw" style="background:var(--c6)"></span>
    </span></div>
    <div class="small">Diseño simple — editable • Guarda en localStorage</div>
  </div>
</footer>

<script>
/*
  Datos de materias y prerequisitos.
  Estructura: codigo: { name, term (1..15), prereqs: [codigos], colorClass }
  Nota: term usamos 1..15 (I..XV). Ajusta colores editando colorClass.
*/
const courses = {
  /* Primer Año (I - III) */
  "DA1111": {name:"Geometría Descriptiva I", term:1, prereqs:[], color:"c1"},
  "PL1510": {name:"Arquitectura y Urbanismo", term:1, prereqs:[], color:"c2"},
  "MA1111": {name:"Matemáticas I", term:1, prereqs:[], color:"c3"},
  "LLA111": {name:"Lenguaje I", term:1, prereqs:[], color:"c4"},
  "CSA211": {name:"Venezuela ante el siglo XXI I", term:1, prereqs:[], color:"c5"},

  "DA1112": {name:"Geometría Descriptiva II", term:2, prereqs:["DA1111"], color:"c1"},
  "FS1163": {name:"Física Básica", term:2, prereqs:["MA1111"], color:"c6"},
  "MA1112": {name:"Matemáticas II", term:2, prereqs:["MA1111"], color:"c3"},
  "LLA112": {name:"Lenguaje II", term:2, prereqs:["LLA111"], color:"c4"},
  "CSA212": {name:"Venezuela ante el siglo XXI II", term:2, prereqs:["CSA211"], color:"c5"},

  "DA1113": {name:"Dibujo y Perspectiva", term:3, prereqs:["DA1112"], color:"c1"},
  "FS1117": {name:"Física de las Estructuras", term:3, prereqs:["MA1112","FS1163"], color:"c6"},
  "MA1116": {name:"Matemáticas III", term:3, prereqs:["MA1112"], color:"c3"},
  "LLA113": {name:"Lenguaje III", term:3, prereqs:["LLA112"], color:"c4"},
  "CSA213": {name:"Venezuela ante el siglo XXI III", term:3, prereqs:["CSA212"], color:"c5"},

  /* Segundo Año (IV - VI) */
  "DA1311": {name:"Diseño Básico", term:4, prereqs:["DA1113","MA1112"], color:"c2"},
  "DA1211": {name:"Apreciación Plástica I", term:4, prereqs:["DA1113"], color:"c1"},
  "DA1411": {name:"Intro Teoría de la Arquitectura", term:4, prereqs:["PL1510"], color:"c3"},
  "ID2124": {name:"Inglés para Arquitectura I", term:4, prereqs:["_40UNITS_"], color:"c5"},
  "DA2521": {name:"Introducción al Diseño Estructural", term:4, prereqs:["MA1116","FS1117"], color:"c6"},

  "DA1312": {name:"Diseño Arquitectónico I", term:5, prereqs:["DA1311","FS1117"], color:"c2"},
  "DA1212": {name:"Apreciación Plástica II", term:5, prereqs:["DA1211"], color:"c1"},
  "DA1412": {name:"Teoría de la Arquitectura I", term:5, prereqs:["DA1411"], color:"c3"},
  "ID2125": {name:"Inglés II", term:5, prereqs:["ID2124"], color:"c5"},
  "DA2522": {name:"Diseño Estructural", term:5, prereqs:["MC3250","DA1311"], color:"c6"}, // MC3250 not listed => will appear as missing unless manually approved

  "DA1313": {name:"Diseño Arquitectónico II", term:6, prereqs:["DA1312","DA1411","DA1211"], color:"c2"},
  "DA2211": {name:"Apreciación Plástica III", term:6, prereqs:["DA1212"], color:"c1"},
  "DA2411": {name:"Teoría de la Arquitectura II", term:6, prereqs:["DA1412","DA1311"], color:"c3"},
  "ID2126": {name:"Inglés III", term:6, prereqs:["ID2125"], color:"c5"},
  "DA2523": {name:"Proyecto Estructural de Edificaciones", term:6, prereqs:["MC3252","DA1312"], color:"c6"},

  /* Tercer Año (VII - IX) */
  "DA1314": {name:"Diseño Arquitectónico III", term:7, prereqs:["DA1313","MA1116"], color:"c2"},
  "DA2412": {name:"Teoría III", term:7, prereqs:["DA2411"], color:"c3"},
  "ID3124": {name:"Inglés IV", term:7, prereqs:["ID2126"], color:"c5"},
  "DA2541": {name:"Arquitectura y Ambiente", term:7, prereqs:["DA1312"], color:"c6"},
  "STUDGEN": {name:"Estudios Generales (varios)", term:7, prereqs:[], color:"c4"},

  "DA2311": {name:"Diseño Arquitectónico IV", term:8, prereqs:["DA1314"], color:"c2"},
  "DA2413": {name:"Teoría IV", term:8, prereqs:["DA2412"], color:"c3"},
  "DA2511": {name:"Elementos de la Construcción I", term:8, prereqs:["DA1312"], color:"c5"},
  "DA2121": {name:"Expresión Digital I", term:8, prereqs:["DA1311","DA2211"], color:"c1"},
  "STUDGEN2": {name:"Estudios Generales", term:8, prereqs:[], color:"c4"},

  "DA2312": {name:"Diseño Arquitectónico V", term:9, prereqs:["DA2311","DA2412"], color:"c2"},
  "DA3411": {name:"Teoría V", term:9, prereqs:["DA2413"], color:"c3"},
  "DA2512": {name:"Elementos de la Construcción II", term:9, prereqs:["DA2511"], color:"c5"},
  "DA2122": {name:"Expresión Digital II", term:9, prereqs:["DA2121"], color:"c1"},
  "STUDGEN3": {name:"Estudios Generales", term:9, prereqs:[], color:"c4"},

  /* Cuarto Año (X - XII) */
  "DA2313": {name:"Diseño Arquitectónico VI", term:10, prereqs:["DA2312","DA2122"], color:"c2"},
  "DA2561": {name:"Ejercicio de la profesión", term:10, prereqs:["DA2312","DA3411"], color:"c6"},
  "DA2513": {name:"Elementos de la Construcción III", term:10, prereqs:["DA1314","DA2512"], color:"c5"},
  "DA2123": {name:"Expresión Digital III", term:10, prereqs:["DA2122"], color:"c1"},
  "STUDGEN4": {name:"Estudios Generales", term:10, prereqs:[], color:"c4"},

  "DA2314": {name:"Diseño Arquitectónico VII", term:11, prereqs:["DA2313","DA2412"], color:"c2"},
  "DA2562": {name:"Gerencia de Proyectos", term:11, prereqs:["DA2312","DA2512"], color:"c6"},
  "DA4541": {name:"Paisajismo", term:11, prereqs:["DA2541"], color:"c3"},
  "STUDGEN5": {name:"Estudios Generales", term:11, prereqs:[], color:"c4"},

  "DA3311": {name:"Diseño Arquitectónico VIII", term:12, prereqs:["DA2314","MC3253","DA2562"], color:"c2"},
  "DA2563": {name:"Gerencia de Obras", term:12, prereqs:["DA2562"], color:"c6"},
  "ELECT1": {name:"Electiva I", term:12, prereqs:["DA2561"], color:"c1"},
  "STUDGEN6": {name:"Estudios Generales", term:12, prereqs:[], color:"c4"},

  /* Quinto Año (XIII - XV) */
  "DA3312": {name:"Diseño Arquitectónico IX", term:13, prereqs:["DA3311"], color:"c2"},
  "ELECT2": {name:"Electiva II", term:13, prereqs:[], color:"c1"},
  "ELECT3": {name:"Electiva III", term:13, prereqs:[], color:"c1"},

  "DA3313": {name:"Diseño Arquitectónico X", term:14, prereqs:["DA3312"], color:"c2"},
  "EP1107": {name:"Seminario", term:14, prereqs:[], color:"c3"},

  "EP3307": {name:"Proyecto de Grado (Dedicación Exclusiva)", term:15, prereqs:["DA3313","EP1107"], color:"c7"}
};

/* ------- Persistencia y estado ------- */
const STORAGE_KEY = "malla_arq_usb_v1";
let state = {
  approved: new Set(), // codes
  has40: false
};

// carga estado desde localStorage
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const obj = JSON.parse(raw);
      state.approved = new Set(obj.approved || []);
      state.has40 = !!obj.has40;
    }
  }catch(e){ console.warn("No se pudo cargar estado", e); }
}
function saveState(){
  const obj = { approved: Array.from(state.approved), has40: state.has40 };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
}

/* ------- Renderizado ------- */
const gridEl = document.getElementById("grid");
const svg = document.getElementById("connectSvg");
const wrap = document.getElementById("wrap");
const has40El = document.getElementById("has40");

function termLabel(n){
  const roman = ["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII","XIII","XIV","XV"];
  return `Trimestre ${roman[n-1] || n}`;
}

function buildGrid(){
  // construimos 15 columnas (I..XV)
  gridEl.innerHTML = "";
  for(let term=1; term<=15; term++){
    const col = document.createElement("div");
    col.className = "col";
    const title = document.createElement("h3");
    title.textContent = termLabel(term);
    col.appendChild(title);

    // materias para este term
    const items = Object.keys(courses).filter(c => courses[c].term === term)
                    .sort((a,b)=>a.localeCompare(b));
    items.forEach(code => {
      const meta = courses[code];
      const card = document.createElement("div");
      card.className = `course ${meta.color || "c1"}`;
      card.dataset.code = code;

      const codeEl = document.createElement("div"); codeEl.className="code"; codeEl.textContent = code;
      const nameEl = document.createElement("div"); nameEl.className="name"; nameEl.textContent = meta.name;
      const metaEl = document.createElement("div"); metaEl.className="meta";
      metaEl.textContent = (meta.prereqs && meta.prereqs.length)? ("Req: " + meta.prereqs.join(", ")): "";

      card.appendChild(codeEl); card.appendChild(nameEl); card.appendChild(metaEl);

      // badge
      const badge = document.createElement("div"); badge.className="badge"; badge.textContent="Aprobada";
      if(state.approved.has(code)) { card.classList.add("approved"); card.appendChild(badge); }
      // lock / tooltip
      const isLocked = !canTake(code);
      if(isLocked) card.classList.add("locked");

      // tooltip element for locked
      const tt = document.createElement("div"); tt.className="tooltip"; tt.textContent = tooltipTextFor(code);
      card.appendChild(tt);

      // click handler
      card.addEventListener("click", (ev)=>{
        if(canTake(code)){
          toggleApproval(code);
        } else {
          // flash tooltip
          showTooltipFor(card);
        }
      });

      // hover show tooltip when locked
      card.addEventListener("mouseenter", ()=>{ if(card.classList.contains("locked")) showTooltipFor(card); });
      card.addEventListener("mouseleave", ()=>{ hideTooltipFor(card); });

      col.appendChild(card);
    });

    gridEl.appendChild(col);
  }

  // after DOM built, draw connections
  requestAnimationFrame(drawConnections);
}

/* Determina si un curso puede tomarse: todos los prereqs aprobados */
function canTake(code){
  const meta = courses[code];
  if(!meta) return false;
  const reqs = meta.prereqs || [];
  if(reqs.length === 0) return true;
  for(const r of reqs){
    if(r === "_40UNITS_"){
      if(!state.has40) return false;
    } else {
      // if prereq code not in courses (e.g., MC3250) allow only if manually approved
      if(!state.approved.has(r)) return false;
    }
  }
  return true;
}

function tooltipTextFor(code){
  const meta = courses[code];
  const reqs = meta.prereqs || [];
  if(reqs.length===0) return "Sin prerequisitos";
  const missing = reqs.filter(r => {
    if(r === "_40UNITS_") return !state.has40;
    return !state.approved.has(r);
  });
  if(missing.length===0) return "Listo para cursar ✔";
  // humanize _40UNITS_:
  const mm = missing.map(m => m === "_40UNITS_" ? "40 unidades aprobadas" : m);
  return "Falta: " + mm.join(", ");
}

/* Toggle aprobacion */
function toggleApproval(code){
  if(state.approved.has(code)){
    state.approved.delete(code);
  } else {
    state.approved.add(code);
  }
  saveState();
  refreshUI();
}

/* muestra tooltip */
function showTooltipFor(card){
  const tt = card.querySelector(".tooltip");
  if(!tt) return;
  tt.textContent = tooltipTextFor(card.dataset.code);
  tt.classList.add("show");
  // position tooltip relative to card center
  const rect = card.getBoundingClientRect();
  const wrapRect = wrap.getBoundingClientRect();
  const left = (rect.left + rect.right)/2 - wrapRect.left;
  const top = rect.top - wrapRect.top;
  tt.style.left = left + "px";
  tt.style.top = (top) + "px";
}

/* hide tooltip */
function hideTooltipFor(card){
  const tt = card.querySelector(".tooltip");
  if(!tt) return;
  tt.classList.remove("show");
}

/* refresca clases y badges */
function refreshUI(){
  // update has40 checkbox
  has40El.checked = state.has40;

  const cards = document.querySelectorAll(".course");
  cards.forEach(card=>{
    const code = card.dataset.code;
    // approved
    if(state.approved.has(code)){
      card.classList.add("approved");
      if(!card.querySelector(".badge")){
        const badge = document.createElement("div"); badge.className="badge"; badge.textContent="Aprobada";
        card.appendChild(badge);
      }
    } else {
      card.classList.remove("approved");
      const b = card.querySelector(".badge"); if(b) b.remove();
    }
    // locked?
    if(canTake(code)){
      card.classList.remove("locked");
    } else {
      card.classList.add("locked");
    }
    // update tooltip text
    const tt = card.querySelector(".tooltip");
    if(tt){ tt.textContent = tooltipTextFor(code); }
  });

  // redraw lines because positions may have changed
  requestAnimationFrame(drawConnections);
}

/* Dibuja líneas entre prereq -> course */
function drawConnections(){
  // clear svg
  while(svg.firstChild) svg.removeChild(svg.firstChild);
  // find all courses nodes by code -> element and center position
  const nodeMap = {};
  document.querySelectorAll(".course").forEach(el=>{
    nodeMap[el.dataset.code] = el;
  });

  // For each course with prereqs, draw line from each prereq element to this course
  Object.keys(courses).forEach(code=>{
    const meta = courses[code];
    const reqs = meta.prereqs || [];
    reqs.forEach(req=>{
      if(req === "_40UNITS_") return; // no line for units constraint
      const from = nodeMap[req];
      const to = nodeMap[code];
      if(!from || !to) return;

      const r1 = from.getBoundingClientRect();
      const r2 = to.getBoundingClientRect();
      const wrapRect = wrap.getBoundingClientRect();

      const x1 = r1.left + r1.width/2 - wrapRect.left;
      const y1 = r1.top + r1.height - wrapRect.top;
      const x2 = r2.left + r2.width/2 - wrapRect.left;
      const y2 = r2.top - wrapRect.top;

      // draw a curved path (bezier) for nicer look
      const dx = Math.abs(x2-x1);
      const dy = Math.abs(y2-y1);
      const curvature = Math.min(120, Math.max(40, dy/2 + dx/6));
      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      const d = `M ${x1} ${y1} C ${x1} ${y1+curvature} ${x2} ${y2-curvature} ${x2} ${y2}`;
      path.setAttribute("d", d);
      // color line depending if prereq is approved
      const stroke = state.approved.has(req) ? "rgba(42,143,111,0.9)" : "rgba(0,0,0,0.12)";
      path.setAttribute("stroke", stroke);
      path.setAttribute("fill","none");
      path.setAttribute("stroke-width","2");
      path.setAttribute("stroke-linecap","round");
      svg.appendChild(path);

      // arrowhead (small circle) at end
      const circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
      circle.setAttribute("cx", x2);
      circle.setAttribute("cy", y2-3);
      circle.setAttribute("r", 3);
      circle.setAttribute("fill", stroke);
      svg.appendChild(circle);
    });
  });
}

/* Reset */
function resetProgress(){
  if(!confirm("¿Borrar progreso guardado?")) return;
  state.approved = new Set();
  state.has40 = false;
  saveState();
  refreshUI();
}

/* Event listeners */
document.getElementById("resetBtn").addEventListener("click", resetProgress);
has40El.addEventListener("change", (e)=>{
  state.has40 = e.target.checked;
  saveState();
  refreshUI();
});

window.addEventListener("resize", ()=> requestAnimationFrame(drawConnections) );

/* inicialización */
loadState();
buildGrid();
refreshUI();

/* --- Accessibility / small note: permitir aprobar manualmente prereqs externos ---
   Si alguna materia tiene un prerequisito que no está en la lista (por ejemplo MC3250),
   puedes marcar ese código manualmente buscándolo y haciendo click (no aparece).
   Para ayudar, ofrecemos atajo: al presionar "A" abre un prompt para aprobar código manual.
*/
window.addEventListener("keydown",(e)=>{
  if(e.key.toLowerCase() === "a" && (e.ctrlKey || e.metaKey) ){
    const code = prompt("Marcar/desmarcar aprobación manual de código (ej: MC3250):");
    if(!code) return;
    const c = code.trim().toUpperCase();
    if(state.approved.has(c)) state.approved.delete(c); else state.approved.add(c);
    saveState(); refreshUI();
  }
});
</script>
</body>
</html>
